{% extends "base.html" %}

{% block title %}QR Code Shop{% endblock %}

{% block content %}
    <h1>Welcome to QR Code Shop</h1>

    <!-- Display list of products -->
    <ul class="products">
        {% for product in products %}
        <li class="product-item">
            <h3>{{ product.name }} - KES: {{ product.price }}</h3>
            {% if product.image_filename %}
                <img src="{{ url_for('static', filename='uploads/' + product.image_filename) }}" alt="Image of {{ product.name }}" class="product-image">
            {% endif %}
            <p class="product-description">
                <span class="short-description">{{ product.description[:100] }}...</span>
                <br>
                <br>
                <span class="full-description" style="display:none;">{{ product.description }}</span>
                <a href="#" class="read-more" onclick="toggleDescription(event, this)">Read More</a>
                <br>
                <br>
                <a href="#" class="show-less" style="display:none;" onclick="toggleDescription(event, this)">Show Less</a>
            </p>
            <!-- Link to view the QR code for each product -->
            <img src="{{ url_for('generate_qr', product_id=product.id) }}" alt="QR Code for {{ product.name }}" class="product-qr">
        </li>
        {% endfor %}
    </ul>

    <!-- Inline Script for QR Code Scanning -->
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script>
        // Initialize QR Code scanner
        function onScanSuccess(decodedText, decodedResult) {
            document.getElementById('qr-result').innerText = decodedText;

            // Redirect to initiate payment with product ID from QR code
            const productData = JSON.parse(decodedText);
            const productId = productData.id;
            const productPrice = productData.price

            if (productId) {
                const phoneNumber = prompt("Enter your phone number to complete the payment:");
                if (phoneNumber) {
                    fetch('/initiate_payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ product_id: productId, phone_number: phoneNumber })
                    })
                    .then(response => response.json())
                    .then(data => alert(data.message || data.error))
                    .catch(err => alert("Payment failed. Please try again."));
                }
            } else {
                alert("Invalid QR code.");
            }
        }

        const qrReader = new Html5Qrcode("qr-reader");
        qrReader.start({ facingMode: "environment" }, {}, onScanSuccess);

        // Toggle description visibility
        function toggleDescription(event, element) {
            event.preventDefault();
            const description = element.parentElement;
            const shortDescription = description.querySelector('.short-description');
            const fullDescription = description.querySelector('.full-description');
            const readMore = description.querySelector('.read-more');
            const showLess = description.querySelector('.show-less');

            if (fullDescription.style.display === 'none') {
                fullDescription.style.display = 'inline';
                shortDescription.style.display = 'none';
                readMore.style.display = 'none';
                showLess.style.display = 'inline';
            } else {
                fullDescription.style.display = 'none';
                shortDescription.style.display = 'inline';
                readMore.style.display = 'inline';
                showLess.style.display = 'none';
            }
        }
    </script>
{% endblock %}
